<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Presigned POST Upload Test</title>
		<style>
			body {
				font-family: system-ui, sans-serif;
				margin: 2rem;
				max-width: 900px;
			}
			fieldset {
				margin-bottom: 1rem;
			}
			input,
			select,
			button {
				padding: 0.5rem;
				margin: 0.25rem 0;
				width: 100%;
			}
			button {
				cursor: pointer;
				background: #0969da;
				color: white;
				border: none;
				border-radius: 6px;
				font-weight: 500;
				transition: background 0.2s;
			}
			button:hover:not(:disabled) {
				background: #0860ca;
			}
			button:disabled {
				background: #94a3b8;
				cursor: not-allowed;
			}
			button.loading {
				position: relative;
				color: transparent;
			}
			button.loading::after {
				content: "";
				position: absolute;
				width: 16px;
				height: 16px;
				top: 50%;
				left: 50%;
				margin-left: -8px;
				margin-top: -8px;
				border: 2px solid #ffffff;
				border-radius: 50%;
				border-top-color: transparent;
				animation: spin 0.6s linear infinite;
			}
			@keyframes spin {
				to {
					transform: rotate(360deg);
				}
			}
			.row {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 1rem;
			}
			.progress-container {
				margin: 1rem 0;
				display: none;
			}
			.progress-container.active {
				display: block;
			}
			.progress-bar {
				width: 100%;
				height: 24px;
				background: #e5e7eb;
				border-radius: 12px;
				overflow: hidden;
				position: relative;
			}
			.progress-fill {
				height: 100%;
				background: linear-gradient(90deg, #0969da, #54aeff);
				transition: width 0.3s ease;
				display: flex;
				align-items: center;
				justify-content: center;
				color: white;
				font-size: 12px;
				font-weight: 600;
			}
			.progress-text {
				margin-top: 0.5rem;
				font-size: 14px;
				color: #666;
			}
			.status-badge {
				display: inline-block;
				padding: 0.25rem 0.75rem;
				border-radius: 12px;
				font-size: 12px;
				font-weight: 500;
				margin: 0.5rem 0;
			}
			.status-success {
				background: #d1fae5;
				color: #065f46;
			}
			.status-error {
				background: #fee2e2;
				color: #991b1b;
			}
			.status-info {
				background: #dbeafe;
				color: #1e40af;
			}
			.log {
				white-space: pre-wrap;
				background: #f6f8fa;
				padding: 1rem;
				border: 1px solid #ddd;
				border-radius: 6px;
				max-height: 400px;
				overflow-y: auto;
				font-size: 13px;
				font-family: "Consolas", "Monaco", monospace;
			}
			.file-info {
				margin-top: 0.5rem;
				padding: 0.5rem;
				background: #f8fafc;
				border-radius: 4px;
				font-size: 14px;
				display: none;
			}
			.file-info.active {
				display: block;
			}
		</style>
	</head>
	<body>
		<h1>Presigned POST Upload Test</h1>
		<p>
			This page tests the presigned POST workflow: initiate â†’ direct upload to S3/MinIO â†’ complete.
		</p>

		<fieldset>
			<legend>Auth</legend>
			<label>
				JWT Token (Bearer):
				<input id="token" type="text" placeholder="eyJhbGciOi..." />
			</label>
		</fieldset>

		<fieldset>
			<legend>Video Metadata</legend>
			<div class="row">
				<label>
					Title
					<input id="title" type="text" value="My Test Video" />
				</label>
				<label>
					Visibility
					<select id="visibility">
						<option value="public">public</option>
						<option value="link-only">link-only</option>
						<option value="hidden">hidden</option>
					</select>
				</label>
			</div>
			<label>
				Description
				<input id="description" type="text" value="Testing presigned POST upload" />
			</label>
			<label>
				Video File
				<input id="file" type="file" accept="video/*" />
			</label>
			<div id="file-info" class="file-info"></div>
		</fieldset>

		<div class="progress-container" id="progress-container">
			<div class="progress-bar">
				<div class="progress-fill" id="progress-fill">0%</div>
			</div>
			<div class="progress-text" id="progress-text">Preparing upload...</div>
		</div>

		<div id="status-container"></div>

		<div class="row">
			<button id="btn-initiate">1) Initiate Upload</button>
			<button id="btn-upload" disabled>2) Upload to S3/MinIO</button>
		</div>
		<div class="row">
			<button id="btn-complete" disabled>3) Complete Upload</button>
			<button id="btn-reset">Reset</button>
		</div>

		<h3>Log</h3>
		<div class="log" id="log"></div>

		<script>
			const apiBase = "http://localhost:3000/api";
			let presigned = null; // { url, fields }
			let key = null; // S3 object key
			let lastFile = null; // File selected

			const $ = (id) => document.getElementById(id);
			const log = (msg, obj) => {
				const out = obj ? `${msg}:\n${JSON.stringify(obj, null, 2)}` : msg;
				const el = $("log");
				el.textContent = `${el.textContent}\n\n${out}`.trim();
				el.scrollTop = el.scrollHeight;
			};

			const showProgress = (visible) => {
				$("progress-container").classList.toggle("active", visible);
			};

			const updateProgress = (percent, text) => {
				const fill = $("progress-fill");
				fill.style.width = `${percent}%`;
				fill.textContent = `${Math.round(percent)}%`;
				$("progress-text").textContent = text;
			};

			const showStatus = (message, type = "info") => {
				const badge = document.createElement("div");
				badge.className = `status-badge status-${type}`;
				badge.textContent = message;
				const container = $("status-container");
				container.innerHTML = "";
				container.appendChild(badge);
			};

			const setButtonLoading = (btnId, loading) => {
				const btn = $(btnId);
				btn.disabled = loading;
				btn.classList.toggle("loading", loading);
			};

			const formatFileSize = (bytes) => {
				if (bytes < 1024) return bytes + " B";
				if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
				if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + " MB";
				return (bytes / (1024 * 1024 * 1024)).toFixed(2) + " GB";
			};

			$("file").addEventListener("change", (e) => {
				const file = e.target.files[0];
				if (file) {
					const info = $("file-info");
					info.classList.add("active");
					info.innerHTML = `
						<strong>ðŸ“¹ ${file.name}</strong><br>
						Size: ${formatFileSize(file.size)} | Type: ${file.type || "unknown"}
					`;
				}
			});

			$("btn-reset").onclick = () => {
				presigned = null;
				key = null;
				lastFile = null;
				$("btn-upload").disabled = true;
				$("btn-complete").disabled = true;
				$("log").textContent = "";
				$("file").value = "";
				$("file-info").classList.remove("active");
				showProgress(false);
				$("status-container").innerHTML = "";
			};

			$("btn-initiate").onclick = async () => {
				try {
					const token = $("token").value.trim();
					const file = $("file").files[0];
					if (!token) return alert("Provide JWT token");
					if (!file) return alert("Choose a video file");
					lastFile = file;

					setButtonLoading("btn-initiate", true);
					showProgress(true);
					updateProgress(10, "Requesting upload URL...");

					const body = {
						title: $("title").value.trim(),
						description: $("description").value.trim(),
						visibility: $("visibility").value,
						filename: file.name,
						contentType: file.type || "video/mp4",
						declaredSize: file.size,
					};

					const res = await fetch(`${apiBase}/videos/initiate`, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
							Authorization: `Bearer ${token}`,
						},
						body: JSON.stringify(body),
					});
					const data = await res.json();
					if (!res.ok) throw new Error(data?.message || data?.msg || res.statusText);

					// data: { key, upload: { url, fields } }
					key = data.key;
					presigned = data.upload;
					$("btn-upload").disabled = false;
					updateProgress(25, "Ready to upload!");
					showStatus("âœ“ Upload URL obtained", "success");
					log("Initiate response", data);
				} catch (e) {
					showProgress(false);
					showStatus("âœ— Initiation failed: " + e.message, "error");
					log("Initiate error", { error: String(e) });
				} finally {
					setButtonLoading("btn-initiate", false);
				}
			};

			$("btn-upload").onclick = async () => {
				try {
					if (!presigned || !lastFile) return alert("Run initiate and select a file first");

					setButtonLoading("btn-upload", true);
					updateProgress(30, "Uploading to storage...");

					const form = new FormData();
					// Append presigned fields first
					Object.entries(presigned.fields).forEach(([k, v]) => form.append(k, v));
					// Critical: if policy requires Content-Type, include it as a form field
					if (!presigned.fields["Content-Type"] && lastFile.type) {
						form.append("Content-Type", lastFile.type);
					}
					// Then the file field named "file"
					form.append("file", lastFile);

					// Use XMLHttpRequest for upload progress tracking
					await new Promise((resolve, reject) => {
						const xhr = new XMLHttpRequest();

						xhr.upload.addEventListener("progress", (e) => {
							if (e.lengthComputable) {
								const percent = 30 + (e.loaded / e.total) * 50; // 30% to 80%
								updateProgress(
									percent,
									`Uploading: ${formatFileSize(e.loaded)} / ${formatFileSize(e.total)}`,
								);
							}
						});

						xhr.addEventListener("load", () => {
							if (xhr.status >= 200 && xhr.status < 300) {
								resolve(xhr.response);
							} else {
								reject(new Error(`Upload failed: ${xhr.status}`));
							}
						});

						xhr.addEventListener("error", () => reject(new Error("Network error during upload")));
						xhr.addEventListener("abort", () => reject(new Error("Upload aborted")));

						xhr.open("POST", presigned.url);
						xhr.send(form);
					});

					updateProgress(80, "Upload complete!");
					$("btn-complete").disabled = false;
					showStatus("âœ“ File uploaded to storage", "success");
					log("Upload success (S3/MinIO response)");
				} catch (e) {
					showStatus("âœ— Upload failed: " + e.message, "error");
					log("Upload error", { error: String(e) });
				} finally {
					setButtonLoading("btn-upload", false);
				}
			};

			$("btn-complete").onclick = async () => {
				try {
					const token = $("token").value.trim();
					if (!token) return alert("Provide JWT token");
					if (!key) return alert("No key; run initiate first");

					setButtonLoading("btn-complete", true);
					updateProgress(85, "Finalizing upload...");

					const body = {
						key,
					};

					const res = await fetch(`${apiBase}/videos/complete`, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
							Authorization: `Bearer ${token}`,
						},
						body: JSON.stringify(body),
					});
					const data = await res.json();
					if (!res.ok) throw new Error(data?.message || data?.msg || res.statusText);

					updateProgress(100, "âœ“ Complete! Video queued for processing");
					showStatus("âœ“ Upload complete! Video is being transcoded", "success");
					log("Complete response (video queued for processing)", data);

					// Disable all buttons after successful completion
					$("btn-initiate").disabled = true;
					$("btn-upload").disabled = true;
					$("btn-complete").disabled = true;
				} catch (e) {
					showStatus("âœ— Completion failed: " + e.message, "error");
					log("Complete error", { error: String(e) });
				} finally {
					setButtonLoading("btn-complete", false);
				}
			};
		</script>
	</body>
</html>
